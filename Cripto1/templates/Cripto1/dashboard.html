{% extends 'Cripto1/base.html' %}

{% block title %}Dashboard - Blockchain App{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12 mb-4">
            <div class="d-flex justify-content-between align-items-center">
                <h2>Dashboard
                    {% if unviewed_received_transactions_count > 0 %}
                        <a href="{% url 'Cripto1:unviewed_transactions_list' %}" style="text-decoration: none;">
                            <span class="badge bg-success rounded-pill" style="font-size: 0.9em; vertical-align: super; margin-left: 5px;">{{ unviewed_received_transactions_count }}</span>
                        </a>
                    {% endif %}
                </h2>
                <div>
                    <a href="{% url 'Cripto1:create_transaction' %}" class="btn btn-primary">
                        <i class="fas fa-plus"></i> New Transaction
                    </a>
                    <button id="mineBlockBtn" class="btn btn-warning ms-2">
                        <i class="fas fa-cube"></i> Crea blocco
                    </button>
                </div>
            </div>
            <div id="miningStatus" class="mt-2"></div>
        </div>
    </div>

    <div class="row">
        <!-- Recent Transactions -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Recent Transactions</h4>
                </div>
                <div class="card-body">
                    {% if transactions %}
                        <div class="list-group">
                            {% for tx in transactions %}
                                <a href="{% url 'Cripto1:transaction_details' tx.id %}" class="list-group-item list-group-item-action">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h5 class="mb-1">
                                            {% if tx.type == 'text' %}
                                                <i class="fas fa-envelope"></i>
                                            {% else %}
                                                <i class="fas fa-file"></i>
                                            {% endif %}
                                            {{ tx.type|title }} Transaction
                                        </h5>
                                        <small>{{ tx.timestamp_datetime }}</small>
                                    </div>
                                    <p class="mb-1">
                                        {% if tx.type == 'text' %}
                                            {{ tx.content|truncatechars:100 }}
                                        {% else %}
                                            File: {{ tx.file.name|slice:"19:" }}
                                        {% endif %}
                                    </p>
                                    <small>
                                        From: {{ tx.sender.username }} | To: {{ tx.receiver.username }}
                                        {% if tx.is_encrypted %}
                                            <span class="badge bg-info">Encrypted</span>
                                        {% endif %}
                                    </small>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No recent transactions.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Blockchain Status -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Blockchain Status</h4>
                </div>
                <div class="card-body">
                    {% if blockchain_state %}
                        <div class="mb-3">
                            <h5>Latest Block</h5>
                            {% if blocks %}
                                <p><strong>Block #{{ blocks.0.index }}</strong></p>
                                <p><small class="text-muted">Hash: {{ blocks.0.hash|truncatechars:20 }}</small></p>
                                <p><small class="text-muted">Timestamp: {{ blocks.0.timestamp_datetime }}</small></p>
                            {% else %}
                                <p class="text-muted">No blocks yet.</p>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <h5>Pending Transactions</h5>
                            <p>{{ pending_count }} transactions waiting to be mined
                                {% if pending_count > 0 %}
                                    <span class="spinner-border spinner-border-sm text-warning" role="status" aria-hidden="true"></span>
                                {% endif %}
                            </p>
                        </div>
                    {% else %}
                        <p class="text-muted">Blockchain not initialized.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Decrypt Modal -->
<div class="modal fade" id="decryptModal" tabindex="-1" aria-labelledby="decryptModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="decryptModalLabel">Note Decriptate</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Mittente:</strong> <span id="decrypted-sender"></span></p>
                <p><strong>Note:</strong> <span id="decrypted-notes"></span></p>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container for Welcome Message -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="welcomeToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Benvenuto!</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" style="padding: 1.5rem;">
            Benvenuto! Hai effettuato l'accesso con successo.
            <div class="mt-3 pt-3 border-top" style="margin-top: 1rem; display: flex; gap: 1rem;">
                <a href="{{ create_transaction_url }}" class="btn btn-primary btn-sm">Crea Transazione</a>
                <a href="{{ all_transactions_url }}" class="btn btn-secondary btn-sm">Visualizza Tutte le Transazioni</a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    $('#transactionForm').submit(function(e) {
        e.preventDefault();
        var form = $(this);
        var status = $('#transactionStatus');
        
        form.find('button').prop('disabled', true);
        status.html('<div class="alert alert-info">Transazione in corso...</div>');
        
        $.post('{% url "Cripto1:create_transaction" %}', form.serialize())
        .done(function(response) {
            if (response.success) {
                status.html('<div class="alert alert-success">' + response.message + '</div>');
                form[0].reset();
                setTimeout(function() {
                    location.reload();
                }, 2000);
            } else {
                status.html('<div class="alert alert-danger">' + response.message + '</div>');
            }
        })
        .fail(function() {
            status.html('<div class="alert alert-danger">Errore durante la transazione</div>');
        })
        .always(function() {
            form.find('button').prop('disabled', false);
        });
    });

    const mineBtn = document.getElementById('mineBlockBtn');
    const miningStatus = document.getElementById('miningStatus');
    if (mineBtn) {
        mineBtn.addEventListener('click', function() {
            mineBtn.disabled = true;
            miningStatus.innerHTML = '<div class="alert alert-info">Creazione blocco in corso...</div>';
            fetch('{% url "Cripto1:mine_block" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    miningStatus.innerHTML = '<div class="alert alert-success">' + data.message + '</div>';
                    setTimeout(function() { location.reload(); }, 1500);
                } else {
                    miningStatus.innerHTML = '<div class="alert alert-danger">' + data.message + '</div>';
                }
            })
            .catch(error => {
                miningStatus.innerHTML = '<div class="alert alert-danger">Errore durante la creazione del blocco.</div>';
            })
            .finally(() => {
                mineBtn.disabled = false;
            });
        });
    }

    // Show welcome toast if a message with 'welcome_toast' tag exists
    {% if messages %}
        {% for message in messages %}
            {% if 'welcome_toast' in message.tags %}
                var welcomeToastEl = document.getElementById('welcomeToast');
                var welcomeToast = new bootstrap.Toast(welcomeToastEl, {
                    autohide: false
                });
                welcomeToast.show();
                // Remove the message from the regular messages display after showing the toast
                var successAlert = document.querySelector('.alert.alert-success');
                if (successAlert) {
                    successAlert.remove();
                }
            {% endif %}
        {% endfor %}
    {% endif %}
});
</script>
{% endblock %}

<style>
    .mini-cube {
        display: inline-block;
        width: 20px;
        height: 20px;
        position: relative;
        transform-style: preserve-3d;
        animation: rotate 2s infinite linear;
        margin-left: 8px;
        vertical-align: middle;
    }

    .cube-face {
        position: absolute;
        width: 100%;
        height: 100%;
        background: var(--bs-primary);
        opacity: 0.8;
    }

    .front  { transform: rotateY(0deg) translateZ(10px); }
    .back   { transform: rotateY(180deg) translateZ(10px); }
    .right  { transform: rotateY(90deg) translateZ(10px); }
    .left   { transform: rotateY(-90deg) translateZ(10px); }
    .top    { transform: rotateX(90deg) translateZ(10px); }
    .bottom { transform: rotateX(-90deg) translateZ(10px); }

    @keyframes rotate {
        0% { transform: rotateX(0deg) rotateY(0deg); }
        100% { transform: rotateX(360deg) rotateY(360deg); }
    }
</style>